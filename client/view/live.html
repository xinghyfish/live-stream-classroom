<!doctype html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- 规定文档的字符编码。 -->
    <title>{{ teacherName }}的{{ courseName }}直播间</title>
    <link type="text/css" href="{{ static_url('css/live-style.css') }}" rel="stylesheet"/>

</head>
<body onload="onLoadWS()">
<div id="video-module">
	<div id="member-list" class="pop-div">
        <div class="member-item" v-for="member in members">
            <span class="item-username">[[ member ]]</span>
            <button class="item-btn">查看摄像头</button>
            <button class="item-btn">查看屏幕</button>
        </div>
	</div>
	<div id="app-list" class="pop-div">
        <div class="app-item" v-for="(app, index) in apps" :key="index" @click="getLists(app.event)">
            <img :src=app.icon :alt=app.name class="app-icon">
            <div class="app-name">[[ app.name ]]</div>
        </div>
	</div>

    <div id="course-info">
        <img src="../static/avatars/{{ teacherName }}.jpg"  id="avatar" alt="头像"></img>
        <div id="teacherName"><b>授课老师：</b>{{ teacherName }}</div>
        <div id="courseName"><b>授课内容：</b>{{ courseName }}</div>
        <div id="people-count"><b>在线人数：</b>[[ peopleCount ]]</div>
    </div>
    <div id="video-part">
        <video id="localVideo" autoplay playsinline>
        </video>
    </div>

    <div id="tool-part">
        <div id="microphone" class="item" @click="open = !open">
            <img v-if="open" src="../static/icons/麦克风.svg" alt="开启麦克风" class="icon">
            <img v-else src="../static/icons/关闭麦克风.svg" alt="关闭麦克风" class="icon">
            <div class="caption">
                <span v-if="open">麦克风打开</span>
                <span v-else>麦克风关闭</span>
            </div>
        </div>
        <div id="camera" class="item" @click="camera()">
            <img v-if="open" src="../static/icons/摄像头.svg" alt="开启屏幕" class="icon">
            <img v-else src="../static/icons/摄像头_关闭.svg" alt="关闭屏幕" class="icon">
            <div class="caption">
                <span v-if="open">摄像头打开</span>
                <span v-else>摄像头关闭</span>
            </div>
        </div>
        <div id="share-screen" class="item" @click="shareScreen()">
            <img v-if="open" src="../static/icons/开启屏幕.svg" alt="结束共享" class="icon">
            <img v-else src="../static/icons/关闭屏幕.svg" alt="开始共享" class="icon">
            <div class="caption">
                <span v-if="open">结束共享</span>
                <span v-else>开始共享</span>
            </div>
        </div>
        <div id="member" class="item" @click="showMemberList()">
            <img src="../static/icons/好友.svg" alt="查看成员" class="icon">
            <div class="caption">查看成员</div>
        </div>
        <div id="record-screen" class="item" @click="open = !open">
            <img v-if="open" src="../static/icons/摄像头.svg" alt="结束录制" class="icon">
            <img v-else src="../static/icons/摄像头_关闭.svg" alt="开始录制" class="icon">
            <div class="caption">
                <span v-if="open">结束录制</span>
                <span v-else>开始录制</span>
            </div>
        </div>
        <div id="files" class="item">
            <img src="../static/icons/文件夹.svg" alt="在线文件" class="icon">
            <div class="caption">
                <span>在线文件</span>
            </div>
        </div>
        <div id="apps" class="item" @click="showApps()">
            <img src="../static/icons/应用.svg" alt="应用" class="icon">
            <div class="caption">
                <span>查看应用</span>
            </div>
        </div>
        <div id="setting" class="item">
            <img src="../static/icons/icon_设置.svg" alt="设置" class="icon">
            <div class="caption">
                <span>设置</span>
            </div>
        </div>
    </div>
</div>

<div id="chat-module">
    <div id="char-head">
        <img class="chat-bubble" src="../static/icons/说话气泡.svg" alt="聊天">
        <span style="position: relative; left: 10px; font-size: 18px; top: 2px;">聊天</span>
    </div>
    <div id="chat-body">
<!--        <span v-for="message in messages"></span>-->
    </div>
    <div id="emoji-part">
        <img class="emoji" src="../static/icons/表情.svg" alt="表情">
        <img class="emoji" src="../static/icons/上传文件.svg" alt="上传文件">
    </div>
    <div id="input-part">
        <textarea class="text" id="user-input" placeholder="输入消息…"></textarea>
    </div>
    <div id="send-part">
        <input id="send-button" value="发送消息" type="button" onclick="sendMsg();">
    </div>
</div>
</body>

<script src="../static/js/vue.js"></script>
<script>

    function get_cookie(name) {
        const strCookie = document.cookie;
        const arrCookie = strCookie.split("; ");
        for (let i = 0; i < arrCookie.length; ++i) {
            let arr = arrCookie[i].split("=");
            if (arr[0] === name)
                return arr[1]
        }
        return ""
    }

    // 声明全局变量
    const username = get_cookie("username");
    var chatWS;
    var signupWS;

	let historyVm = new Vue({
        el: '#chat-body',
        data: {
            messages: [],
        },
    });

    const microphoneVm = new Vue({
        el: '#microphone',
        data: {
            open: false
        },
    });

    const cameraVm = new Vue({
        el: '#camera',
        data: {
            open: false
        },
        methods: {
            camera: function () {
                this.open = !this.open;
                if (this.open === false)
                    localPeerConnection.close();
                // else
                //     callAction();
            }
        }
    });

    const shareScreenVm = new Vue({
        el: '#share-screen',
        data: {
            open: false
        },
        methods: {
            shareScreen: function () {
                this.open = !this.open;
                if (this.open === true) {

                }
            }
        }
    });

    const recordScreenVm = new Vue({
        el: '#record-screen',
        data: {
            open: false
        }
    });

    const memberListVm = new Vue({
        delimiters: ['[[', ']]'],
        el: '#member-list',
        data: {
            members: []
        },
        computed: {
            isShow() {
                return this.members && this.members.length > 0
            }
		}
    });

	const memberVm = new Vue({
		el: '#member',
		data: {
			open: false,
		},
		methods: {
			showMemberList: function() {
				this.open = !this.open;
				appVm.open = false;
				this.showOrHide();
				appVm.showOrHide();
			},

			showOrHide: function() {
				const memberList = document.getElementById('member-list');
				if (this.open) memberList.style.display = "block";
				else memberList.style.display = "none";
			}
		},
	});

    const peopleCountVm = new Vue({
        delimiters: ['[[', ']]'],
        el: '#people-count',
        data: {
            peopleCount: memberListVm.members.length
        },
    });

	const appVm = new Vue({
		el: '#apps',
		data: {
			open: false
		},
		methods: {
			showApps: function() {
				this.open = !this.open;
				memberVm.open = false;
				this.showOrHide();
				memberVm.showOrHide();
			},
			showOrHide: function() {
				const appList = document.getElementById('app-list');
				if (this.open) appList.style.display = 'block';
				else appList.style.display = 'none';
			}
		}
	});

    const appListVm = new Vue({
        delimiters: ['[[', ']]'],
        el: '#app-list',
        data: {
            apps: [
                { event: 'drawEvent', name: '白板', icon: '../static/icons/白板.svg' },
                { event: 'singupEvent', name: '签到', icon: '../static/icons/签到.svg'},
            ]
        },
        methods: {
            getLists: function(itemMethods) {
                if (itemMethods == "drawEvent")
                    this.drawEvent();
                else 
                    this.signupEvent();
            },
            drawEvent: function() {
                window.location.href = "/draw";
            },
            signupEvent: function() {
                console.log("YES");
                if (username !== '{{ teacherName }}')
                    alert("您的身份不是教师，无法发布签到内容！");
                else
                    signupWS.send("start-signup");
            }
        }
    });

    function onLoadWS() {
        chatWS = new WebSocket("ws://" + window.location.host + "/chat?teacherName=" + '{{ teacherName }}' + "&courseName=" + '{{ courseName }}')
        chatWS.onopen = function () {
            chatWS.send(username + "**#*");
			memberListVm.members.push(username);
        }
        chatWS.onmessage = function (e) {
            historyVm.messages.push(e.data);
            let his_box = document.getElementById('chat-body');
            his_box.scrollTop = his_box.scrollHeight;
        }
        chatWS.onclose = function () {
			memberListVm.members.forEach(function(item, index, arr) {
				if (item === username)
					arr.splice(index, 1);
			});
            alert("close");
            if (username !== '{{ teacherName }}')
                window.location.href = "/student/user-web";
            else
                window.location.href = "/teacher/user-web";
        }

        signupWS = new WebSocket("ws://" + window.location.host + "/signup?teacherName=" + '{{ teacherName }}' + "&courseName=" + '{{ courseName }}');
        signupWS.onopen = function () {
            return;
        }
        signupWS.onmessage = function (e) {
            var signupWin = confirm("签到提醒");
            let start_time = new Date();
            if (signupWin == true)
                signupWS.send("confirm-signup " + username + " " + start_time);
            else 
                signupWS.send("refuse-signup " + username);
        }
    }

    function sendMsg() {
        chatWS.send(document.getElementById('user-input').value);
        document.getElementById("user-input").value = "";
    }

    function log_out() {
        if (username !== '{{ teacherName }}')
            window.location.href = "/student/user-web";
        else
            window.location.href = "/teacher/user-web";
    }

</script>
</html>