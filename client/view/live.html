<!doctype html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- 规定文档的字符编码。 -->
    <title>{{ teacherName }}的{{ courseName }}直播间</title>
    <link type="text/css" href="{{ static_url('css/live-style.css') }}" rel="stylesheet"/>

</head>
<body onload="onLoad()">
<div id="video-module">
	<div id="member-list" class="pop-div">
        <div class="member-item" v-for="member in members">
            <span class="item-username">[[ member ]]</span>
            <button class="item-btn" @click="watchVideo(member)">查看摄像头</button>
            <button class="item-btn" @click="watchScreen(member)">查看屏幕</button>
        </div>
	</div>
	<div id="app-list" class="pop-div">
        <div class="app-item" v-for="(app, index) in apps" :key="index" @click="getLists(app.event)">
            <img :src=app.icon :alt=app.name class="app-icon">
            <div class="app-name">[[ app.name ]]</div>
        </div>
	</div>

    <div id="course-info">
        <img src="../static/avatars/{{ teacherName }}.jpg"  id="avatar" alt="头像"></img>
        <div id="teacherName"><b>授课老师：</b>{{ teacherName }}</div>
        <div id="courseName"><b>授课内容：</b>{{ courseName }}</div>
        <div id="people-count"><b>在线人数：</b>[[ peopleCount ]]</div>
    </div>
    <div id="video-part">
        <video id="localClient" autoplay playsinline></video>
        <video id="remoteClient" autoplay playsinline>S</video>
    </div>

    <div id="tool-part">
        <div id="microphone" class="item" @click="microphone()">
            <img v-if="open" src="../static/icons/麦克风.svg" alt="开启麦克风" class="icon">
            <img v-else src="../static/icons/关闭麦克风.svg" alt="关闭麦克风" class="icon">
            <div class="caption">
                <span v-if="open">麦克风打开</span>
                <span v-else>麦克风关闭</span>
            </div>
        </div>
        <div id="camera" class="item" @click="camera()">
            <img v-if="open" src="../static/icons/摄像头.svg" alt="开启屏幕" class="icon">
            <img v-else src="../static/icons/摄像头_关闭.svg" alt="关闭屏幕" class="icon">
            <div class="caption">
                <span v-if="open">摄像头打开</span>
                <span v-else>摄像头关闭</span>
            </div>
        </div>
        <div id="share-screen" class="item" @click="shareScreen()">
            <img v-if="open" src="../static/icons/开启屏幕.svg" alt="结束共享" class="icon">
            <img v-else src="../static/icons/关闭屏幕.svg" alt="开始共享" class="icon">
            <div class="caption">
                <span v-if="open">结束共享</span>
                <span v-else>开始共享</span>
            </div>
        </div>
        <div id="member" class="item" @click="showMemberList()">
            <img src="../static/icons/好友.svg" alt="查看成员" class="icon">
            <div class="caption">查看成员</div>
        </div>
        <div id="record-screen" class="item" @click="open = !open">
            <img v-if="open" src="../static/icons/摄像头.svg" alt="结束录制" class="icon">
            <img v-else src="../static/icons/摄像头_关闭.svg" alt="开始录制" class="icon">
            <div class="caption">
                <span v-if="open">结束录制</span>
                <span v-else>开始录制</span>
            </div>
        </div>
        <div id="files" class="item">
            <img src="../static/icons/文件夹.svg" alt="在线文件" class="icon">
            <div class="caption">
                <span>在线文件</span>
            </div>
        </div>
        <div id="apps" class="item" @click="showApps()">
            <img src="../static/icons/应用.svg" alt="应用" class="icon">
            <div class="caption">
                <span>查看应用</span>
            </div>
        </div>
        <div id="setting" class="item">
            <img src="../static/icons/icon_设置.svg" alt="设置" class="icon">
            <div class="caption">
                <span>设置</span>
            </div>
        </div>
        <div id="exit">
            <button id="exit-btn" onclick="exit()">退出直播</button>
        </div>
    </div>
</div>

<div id="chat-module">
    <div id="char-head">
        <img class="chat-bubble" src="../static/icons/说话气泡.svg" alt="聊天">
        <span style="position: relative; left: 10px; font-size: 18px; top: 2px;">聊天</span>
    </div>
    <div id="chat-body">
<!--        <span v-for="message in messages"></span>-->
    </div>
    <div id="emoji-part">
        <img class="emoji" src="../static/icons/表情.svg" alt="表情">
        <img class="emoji" src="../static/icons/上传文件.svg" alt="上传文件">
    </div>
    <div id="input-part">
        <textarea class="text" id="user-input" placeholder="输入消息…"></textarea>
    </div>
    <div id="send-part">
        <input id="send-button" value="发送消息" type="button" onclick="sendMsg();">
    </div>
</div>
</body>

<script src="../static/js/vue.js"></script>
<script>

    function get_cookie(name) {
        const strCookie = document.cookie;
        const arrCookie = strCookie.split("; ");
        for (let i = 0; i < arrCookie.length; ++i) {
            let arr = arrCookie[i].split("=");
            if (arr[0] === name)
                return arr[1];
        }
        return "";
    }

    // 声明全局变量
    const username = get_cookie("username");
    var ws;

	let historyVm = new Vue({
        el: '#chat-body',
        data: {
            messages: [],
        },
    });

    const microphoneVm = new Vue({
        el: '#microphone',
        data: {
            open: false
        },
        methods: {
            microphone: function() {
                this.open = !this.open;
                /**
                if (this.open === false) {
                    constraints.audio = false;
                } else {
                    constraints.audio = true;
                }
                initStream();
                */
            }
        }
    });

    const cameraVm = new Vue({
        el: '#camera',
        data: {
            open: false
        },
        methods: {
            camera: function () {
                this.open = !this.open;
                if (this.open === false) {
                    userMediaConstraints.video = false;
                } else {
                    userMediaConstraints.video = true;
                }
                loadUserStream();
                startWebRTC();
            }
        }
    });

    const shareScreenVm = new Vue({
        el: '#share-screen',
        data: {
            open: false
        },
        methods: {
            shareScreen: function () {
                this.open = !this.open;
                if (this.open === true) {
                    displayMediaConstraints.video = true;
                } else {
                    displayMediaConstraints.video = false;
                }
                loadDisplayStream();
                startWebRTC()
            }
        }
    });

    const recordScreenVm = new Vue({
        el: '#record-screen',
        data: {
            open: false
        }
    });

    const memberListVm = new Vue({
        delimiters: ['[[', ']]'],
        el: '#member-list',
        data: {
            members: []
        },
        computed: {
            isShow() {
                return this.members && this.members.length > 0
            }
		}
    });

	const memberVm = new Vue({
		el: '#member',
		data: {
			open: false,
		},
		methods: {
			showMemberList: function() {
				ws.send(JSON.stringify({
                    type: "offer-member-list"
                }));
                this.open = !this.open;
                appVm.open = false;
                this.showOrHide();
                appVm.showOrHide();
			},

			showOrHide: function() {
				const memberList = document.getElementById('member-list');
				if (this.open) memberList.style.display = "block";
				else memberList.style.display = "none";
			}
		},
	});

    const peopleCountVm = new Vue({
        delimiters: ['[[', ']]'],
        el: '#people-count',
        data: {
            peopleCount: 0
        },
    });

	const appVm = new Vue({
		el: '#apps',
		data: {
			open: false
		},
		methods: {
			showApps: function() {
				this.open = !this.open;
				memberVm.open = false;
				this.showOrHide();
				memberVm.showOrHide();
			},
			showOrHide: function() {
				const appList = document.getElementById('app-list');
				if (this.open) appList.style.display = 'block';
				else appList.style.display = 'none';
			}
		}
	});

    const appListVm = new Vue({
        delimiters: ['[[', ']]'],
        el: '#app-list',
        data: {
            apps: [
                { event: 'drawEvent', name: '白板', icon: '../static/icons/白板.svg' },
                { event: 'singupEvent', name: '签到', icon: '../static/icons/签到.svg'},
            ]
        },
        methods: {
            getLists: function(itemMethods) {
                if (itemMethods == "drawEvent")
                    this.drawEvent();
                else 
                    this.signupEvent();
            },
            drawEvent: function() {
                window.location.href = "/draw";
            },
            signupEvent: function() {
                console.log("YES");
                if (username !== '{{ teacherName }}')
                    alert("您的身份不是教师，无法发布签到内容！");
                else
                    ws.send(JSON.stringify({ type: "offer-signup" }));
            }
        }
    });

    let configuration = {}; // { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
    let startButton = document.getElementById("startButton");
    let localClient = document.getElementById("localClient");
    let remoteClient = document.getElementById("remoteClient");

    // RTC点对点配置
    let localConnection = new RTCPeerConnection(configuration);
    let remoteConnection = new RTCPeerConnection(configuration);

    let userMediaConstraints = {
        audio: true,
        video: false,
    };

    let displayMediaConstraints = {
        audio: true,
        video: false,
    }

    function loadUserStream() {
        navigator.mediaDevices.getUserMedia(
            userMediaConstraints
        ).then((stream) => {
            localClient.srcObject = stream;
            stream.getTracks().forEach((track) => {
                localConnection.addTrack(track, stream);
            })
        }).catch((error) => {
            console.log(error);
        });
    }

    function loadDisplayStream() {
        navigator.mediaDevices.getDisplayMedia(
            displayMediaConstraints
        ).then((stream) => {
            localClient.srcObject = stream;
            stream.getTracks().forEach((track) => {
                localConnection.addTrack(track, stream);
            })
        }).catch((error) => {
            console.log(error);
        });
    }

    function startWebRTC() {
        console.log("start webRTC");
        localConnection.createOffer().then((offer) => {
            localConnection.setLocalDescription(offer);
            ws.send(JSON.stringify({
                type: "webrtc",
                key: "offer",
                data: offer
            }));
        }).catch((error) => {
            console.log("create offer error: " + error);
        });
    }

    localConnection.oncandidate = (event) => {
        console.log("oncandidate");
        ws.send(JSON.stringify({
            type: "webrtc",
            key: "candidate",
            data: event.candidate
        }));
    }

    remoteConnection.addEventListener('addStream', (event) => {
        console.log("FUCK!");
        remoteClient.srcObject = event.streams[0];
    });

    function receivedCandidate(data) {
        remoteConnection.addIceCandidate(new RTCIceCandidate(data));
    }

    function receivedOffer(data) {
        remoteConnection.setRemoteDescription(data);
        remoteConnection.createAnswer().then((answer) => {
            remoteConnection.setLocalDescription(answer);
            ws.send(JSON.stringify({
                type: "webrtc",
                key: "answer",
                data: data
            }));
        }).catch((error) => {
            console.log("receivedOffer createAnswer error: " + error);
        });
    }

    function receivedAnswer(data) {
        localConnection.setRemoteDescription(data);
    }

    function onLoad() {
        ws = new WebSocket("ws://" + window.location.host + "/ws?teacherName=" + '{{ teacherName }}' + "&courseName=" + '{{ courseName }}')
        ws.onopen = function () {
            ws.send(JSON.stringify({ type: "open-connection", account: username }));
        }

        ws.onmessage = function (e) {
            let message = JSON.parse(e.data);
            console.log(message);
            if (!message)
                console.log("websocket-message ERROR!");

            if (message.type === "close-connection") {
                ws.close();
            } else if (message.type === "user-message") {
                historyVm.messages.push(message.message);
                let his_box = document.getElementById('chat-body');
                his_box.scrollTop = his_box.scrollHeight;
            } else if (message.type === "answer-signup") {
                let info = {
                    type: "answer-signup",
                    status: null,
                    account: username,
                    start_time: null
                }
                var signupWin = confirm("签到提醒");
                if (signupWin == true) {
                    info.start_time = new Date();
                    info.status = "confirm";
                    ws.send(info);
                } else {
                    info.status = "refuse";
                    ws.send(info);
                }
            } else if (message.type === "count-change") {
                peopleCountVm.peopleCount = message.count;
            } else if (message.type === "answer-member-list") {
                memberListVm.members = message.memberlist
            } else if (message.type === "webrtc") {
                switch (message.key) {
                    case "offer":
                        console.log("offer");
                        return receivedOffer(message.data);
                    case "answer":
                        console.log("answer");
                        return receivedAnswer(message.data);
                    case "candidate":
                        console.log("candidate");
                        return receivedCandidate(message.data);
                    default:
                        console.log(message.data);
                }
            }
        }

        ws.onclose = function () {
            if (username !== '{{ teacherName }}')
                window.location.href = "/student/user-web";
            else
                window.location.href = "/teacher/user-web";
        }
    }

    function sendMsg() {
        ws.send(JSON.stringify({
            type: "user-message",
            message: document.getElementById('user-input').value
        }));
        document.getElementById("user-input").value = "";
    }

    function exit() {
        ws.close();
    }
</script>
</html>