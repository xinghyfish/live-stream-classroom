# FFmpegï¼šåŸºç¡€çŸ¥è¯†

## åª’ä½“æ–‡ä»¶

åª’ä½“æ–‡ä»¶çš„æŠ½è±¡ç»„æˆï¼šå®¹å™¨ ( *container* ) + æµ ( *stream* )

- **å®¹å™¨**ï¼šå°†æµå°è£…èµ·æ¥ï¼Œå¯¹å¤–æä¾›æµçš„å”¯ä¸€**æ¥å£**
- **æµ**ï¼šåŒ…å«AVç»„ä»¶ï¼ˆè¯­éŸ³+è§†é¢‘ï¼‰ï¼Œä½¿ç”¨ç¼–ç æ–¹æ³•å¯¹å…¶è¿›è¡Œç¼–ç 

å› æ­¤ï¼Œé€‰æ‹©åˆé€‚çš„æ ¼å¼å’Œå®¹å™¨æ¥å­˜å‚¨åª’ä½“æ–‡ä»¶å°±éå¸¸é‡è¦ã€‚FFmpeg èƒ½å¤Ÿè‡ªåŠ¨é€‰æ‹©åˆé€‚çš„æ ¼å¼å’Œå®¹å™¨ï¼Œè€Œä¸éœ€è¦è¿›è¡Œå¤æ‚çš„é…ç½®ã€‚

## åŸºæœ¬è½¬æ¢

åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨`ffmpeg`å¤„ç†éŸ³é¢‘æ–‡ä»¶çš„åŸºæœ¬æ ¼å¼å¦‚ä¸‹ï¼š

```shell
ffmpeg -i input.mp3 output.ogg
```

ä½¿ç”¨`ffmpeg`å‘½ä»¤ï¼Œå…¶ä¸­`input.mp3`è¡¨ç¤ºè¾“å…¥æ–‡ä»¶ï¼Œ`output.ogg`è¡¨ç¤ºè½¬åŒ–ä¸ºVorbisè¯­éŸ³æµå¹¶å°è£…åœ¨OGGå®¹å™¨ä¸­ã€‚å¯¹äºè§†é¢‘æ–‡ä»¶çš„å¤„ç†ä¹Ÿæœ‰ç±»ä¼¼çš„å‘½ä»¤ï¼š

```shell
ffmpeg -i input.mp4 output.webm
```

# ç½‘ç»œç›´æ’­ï¼šRTMPå’Œæ¨æµæŠ€æœ¯

## æ¨æµæ¦‚è¿°

æ¨æµçš„æ¦‚å¿µå¦‚ä¸‹ï¼š

> æ¨æµï¼ŒæŒ‡çš„æ˜¯æŠŠ**é‡‡é›†é˜¶æ®µå°åŒ…å¥½çš„å†…å®¹ä¼ è¾“åˆ°æœåŠ¡å™¨**çš„è¿‡ç¨‹ã€‚å…¶å®å°±æ˜¯å°†ç°åœºçš„è§†é¢‘ä¿¡å·ä¼ åˆ°ç½‘ç»œçš„è¿‡ç¨‹ã€‚

åœ¨å®é™…ä¸­ï¼Œæ¨æµçš„å·¥ä½œæµå¦‚ä¸‹ï¼š

1. ç”±ã€æ¨æµç«¯ã€‘é‡‡ç”¨**ä¸Šè¡ŒRTMP**æ¨æµåˆ°ã€æºç«™ã€‘
2. ã€æºç«™ã€‘é€šè¿‡**RTMPæ‹‰æµ**åˆ°ã€CDNåˆ†å‘èŠ‚ç‚¹ã€‘
3. ã€CDNåˆ†å‘èŠ‚ç‚¹ã€‘é€šè¿‡ä¸åŒçš„æ‹‰æµåè®®æ‹‰æµåˆ°ä¸åŒçš„ã€æ’­æ”¾ç«¯ã€‘

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸Šè¿°æ•´ä¸ªå·¥ä½œæµç¨‹ä¼ è¾“çš„éŸ³è§†é¢‘æ•°æ®éƒ½æ˜¯å‹ç¼©çš„æ•°æ®æµï¼Œè§£ç çš„å·¥ä½œåœ¨æ’­æ”¾æ®µè¿›è¡Œè§£ç ï¼Œè¿™ä¹Ÿæ˜¯ä¸åŒæ’­æ”¾ç«¯é‡‡å–ä¸åŒæ‹‰æµåè®®çš„åŸå› ã€‚

## RTMPåè®®

`RTMP`çš„å…¨ç§°ä¸º`Real Time Messaging Protocol`ï¼Œå³**å®æ—¶æ¶ˆæ¯ä¼ è¾“åè®®**ï¼Œåœ¨è®¡ç®—æœºç½‘ç»œä¸­å¤„äº**åº”ç”¨å±‚**ã€‚`RTMP`ä¸€èˆ¬åœ¨TCPå±‚ä¼ è¾“`flv`æ ¼å¼æµï¼Œè¯¥æ ¼å¼å³å±äºä¸Šæ–‡æåˆ°çš„å®¹å™¨ï¼Œä½œä¸ºæ•°æ®æµçš„å°è£…ã€‚

> `flv`æ ¼å¼å…¨ç§°ä¸º`flash video`ï¼Œæ˜¯Adobeå…¬å¸å¼€å‘çš„ä¸€ç§ç½‘ç»œè§†é¢‘æ ¼å¼ï¼Œè¯¦ç»†å‚è€ƒè¯æ¡ï¼š[Flash Video - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦ (wikipedia.org)](https://zh.wikipedia.org/wiki/Flash_Video)ã€‚

RTMPåè®®æ—ä½¿ç”¨çš„é»˜è®¤ç«¯å£ä¸º1935ï¼Œé™¤äº†åŸºæœ¬åè®®å¤–è¿˜åŒ…æ‹¬å¤šä¸ªå˜ç§ï¼Œæ¯ä¸ªå˜ç§éƒ½æ”¯æŒä¸åŒçš„åŠŸèƒ½ï¼Œä¾‹å¦‚åŠ å¯†ã€ä½¿ç”¨UDPä½œä¸ºä¼ è¾“å±‚ç­‰ã€‚æ›´å¤šç»†èŠ‚è¿™é‡Œä¸åšè¿‡å¤šèµ˜è¿°ï¼Œåœ¨å‚è€ƒå†…å®¹ä¸­å¯ä»¥è¿›ä¸€æ­¥å­¦ä¹ ã€‚

## ä½¿ç”¨ffmpegçš„rtmpæ¨æµ

ä½¿ç”¨`ffmpeg`åè®®è¿›è¡Œæœ€åŸºç¡€çš„rtmpæ¨æµçš„å‘½ä»¤è¡Œçš„æ ¼å¼å¦‚ä¸‹ï¼š

```shell
ffmpeg -i ${input_video} -f flv rtmp://${server}/live/${streamName}
```

- `-i`ï¼š`input`ï¼Œè¡¨ç¤ºè¾“å…¥è§†é¢‘æ–‡ä»¶ï¼Œåè·Ÿ`${input_video}$`è¡¨ç¤ºè§†é¢‘æ–‡ä»¶è·¯å¾„/URLã€‚
- `-f`ï¼š`format`ï¼Œå¼ºåˆ¶ffmpegé‡‡ç”¨æŸç§æ ¼å¼ï¼Œåè·Ÿå¯¹åº”çš„æ ¼å¼ã€‚

# æ¨æµç›´æ’­demoè®¾è®¡

## ç›´æ’­æµç¨‹

### é€»è¾‘æµç¨‹

1. è°ƒç”¨æ‘„åƒå¤´è·å–éŸ³é¢‘å’Œå›¾åƒ
2. å°†è§†é¢‘åˆ†å‰²ä¸ºå¸§
3. å°†æ¯ä¸€å¸§è¿›è¡Œéœ€æ±‚åŠ å·¥åï¼Œå°†æ­¤å¸§å†™å…¥pipeç®¡é“
4. åˆ©ç”¨`ffmpeg`è¿›è¡Œæ¨æµç›´æ’­

ç¯å¢ƒé…ç½®ï¼š`nginx`æœåŠ¡å™¨ + `nginx-rtmp-module` + `ffmpeg`

### æŠ€æœ¯å®ç°

- ã€è§†é¢‘é‡‡é›†ç«¯ã€‘ï¼šè§†é¢‘è¾“å…¥çš„æ•°æ®é‡‡é›†è®¾å¤‡
- ã€ç›´æ’­æµè§†é¢‘æœåŠ¡ç«¯ã€‘ï¼šä¸€å°`Nginx`æœåŠ¡å™¨ï¼Œé‡‡é›†è§†é¢‘å½•åˆ¶ç«¯ä¼ è¾“çš„è§†é¢‘æµ(`H264/ACC`ç¼–ç )ï¼Œç”±æœåŠ¡å™¨ç«¯è¿›è¡Œè§£æç¼–ç ï¼Œæ¨é€`RTMP/HLS`æ ¼å¼è§†é¢‘æµè‡³è§†é¢‘æ’­æ”¾ç«¯ã€‚
- ã€è§†é¢‘æ’­æ”¾ç«¯ã€‘ï¼šè§†é¢‘è¾“å‡ºç«¯è®¾å¤‡ç›¸å…³è½¯ä»¶ï¼Œæœ¬é¡¹ç›®è®¡åˆ’é‡‡ç”¨`HTML5`çš„`video`æ ‡ç­¾

å› æ­¤ï¼Œéœ€è¦é’ˆå¯¹ä¸Šè¿°æŠ€æœ¯è¿›è¡Œå®ç°ã€‚

## æ¨æ‹‰æµæµ‹è¯•(Windowsç«¯)

åœ¨å¯¹`nginx`è¿›è¡Œé…ç½®çš„è¿‡ç¨‹ä¸­é‡åˆ°äº†ä¸€äº›å›°éš¾ï¼Œåœ¨å®é™…è¿›è¡Œæ¨æµã€æ‹‰æµæµ‹è¯•çš„è¿‡ç¨‹ä¸­é‡åˆ°äº†éå¸¸å¤šçš„é”™è¯¯ï¼ˆ`Unknown error`ï¼Œ`I/O error`ç­‰å„ç§ç±»å‹çš„é”™è¯¯ï¼‰ï¼Œæœ€åæŒ‰ç…§å‚è€ƒå†…å®¹5ä»‹ç»çš„æ–¹æ³•æˆåŠŸå®ç°äº†çš„æ¨æµæ‹‰æµçš„æµ‹è¯•ã€‚ä¸‹é¢æ˜¯ä¸€äº›é…ç½®å’ŒæŒ‡ä»¤ï¼š

- æ¨æµåœ°å€ï¼š`rtmp://127.0.0.1:1935/live/home`
- æ¨æµæµ‹è¯•ï¼š`ffmpeg.exe -re -i ${input-file-path} -vcodec libx264 -acodec aac -f flv rtmp://127.0.0.1:1935/live/home`
- æ‹‰æµæµ‹è¯•ï¼š`ffplay.exe rtmp://localhost:1935/live/home`

æŒ‰ç…§ä¸Šé¢çš„æŒ‡ä»¤ï¼Œç»ˆäºå®Œæˆäº†æ¨æ‹‰æµ`mp4`æ–‡ä»¶çš„ç®€å•æµ‹è¯•ã€‚åˆæ­¥çŒœæµ‹å¯èƒ½æ˜¯æ–‡ä»¶è·¯å¾„ä¸­`\`å†™ä¸º`/`æˆ–è·¯å¾„æ²¡æœ‰å‡é‡‡å–å°å†™å¯¼è‡´çš„ã€‚å®é™…æµ‹è¯•æ—¶ï¼Œæ¨æµçš„æ–‡ä»¶åœ°å€ä¸ºï¼š`D:\server\videos\test.mp4`ï¼Œä½†æ˜¯æµ‹è¯•æ—¶æ­£ç¡®çš„è·¯å¾„ä¸º`d:\server\videos\test.mp4`ï¼Œç»ˆäºå®Œæˆæµ‹è¯•ã€‚æ˜å¤©é¢„è®¡å®ç°æ‘„åƒå¤´å’Œéº¦å…‹é£ç­‰ç¡¬ä»¶è®¾å¤‡çš„æ¨æµæµ‹è¯•ã€‚è®¡åˆ’é¡¹ç›®åæœŸå°†`nginx.conf`é…ç½®æ–‡ä»¶çš„ç›¸å…³å†…å®¹è¿›è¡Œæ›´ä¸ºæ·±å…¥çš„æ¢ç©¶ã€‚

### ç¡¬ä»¶è®¾å¤‡æ•°æ®æ¨æµ

åœ¨ç›´æ’­æ—¶ï¼Œæˆ‘ä»¬ä¸»è¦éœ€è¦çš„**åŠŸèƒ½**ä¸ºï¼šå…±äº«å±å¹•ï¼ˆæ¡Œé¢ï¼‰ã€å¼€å¯è§†é¢‘ï¼ˆæ‘„åƒå¤´ï¼‰å’Œå¼€å¯éº¦å…‹é£ï¼ˆéº¦å…‹é£ï¼‰ã€‚ä¸ºäº†èƒ½å¤Ÿå‡†ç¡®è®¿é—®ç›¸å…³è®¾å¤‡ï¼Œæˆ‘ä»¬éœ€è¦è·å–ç›¸å…³è®¾å¤‡çš„åç§°ã€‚`ffmpeg`æ”¯æŒé€šè¿‡è®¾å¤‡åç§°è®¿é—®è®¾å¤‡ã€‚æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è®¿é—®è®¾å¤‡åç§°ï¼ˆä»¥Windowsç«¯ä¸ºä¾‹ï¼‰

1. æ‰“å¼€Windowsç«¯çš„ã€è®¾å¤‡ç®¡ç†å™¨ã€‘ï¼ŒæŸ¥çœ‹ï¼šã€éŸ³é¢‘è¾“å…¥ä¸è¾“å‡ºã€‘å¾—åˆ°éº¦å…‹é£åç§°ï¼Œã€æ‘„åƒå¤´ã€‘è·å–æ‘„åƒå¤´åç§°
2. åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥ï¼š`ffmpeg -list_devices true -f dshow -i dummy`ï¼Œå¾—åˆ°è®¾å¤‡åç§°åˆ—è¡¨

å¾—åˆ°ç›¸å…³è®¾å¤‡åç§°åï¼Œå³å¯è¿›è¡Œç¡¬ä»¶è®¾å¤‡çš„æ•°æ®æ¨æµï¼Œç›¸å…³æŒ‡ä»¤å¦‚ä¸‹ï¼š

- **æ‘„åƒå¤´æ¨æµ**ï¼š`ffmpeg -f dshow -i video="${camera-name}" -vcodec libx264 -preset:v ultrafast -tune:v zerolatency -f flv rtmp://127.0.0.1:1935/live/home`
- **éº¦å…‹é£æ¨æµ**ï¼š`ffmpeg -f dshow -i audio="${microphone-name}" -vcodec libx264 -preset:v ultrafast -tune:v zerolatency -f flv rtmp://127.0.0.1:1935/live/home`
- **æ‘„åƒå¤´&éº¦å…‹é£æ¨æµ**ï¼š`ffmpeg -f dshow -i video="${camera-name}" -f dshow -i audio="${microphone-name}" -vcodec libx264 -preset:v ultrafast -tune:v zerolatency -f flv rtmp://127.0.0.1:1935/live/home`
- **å±å¹•æ¨æµ**ï¼š`ffmpeg -f gdigrab -i desktop -vcodec libx264 -preset:v ultrafast -tune:v zerolatency -f flv rtmp://127.0.0.1:1935/live/home`
- **å±å¹•&éº¦å…‹é£æ¨æµ***ï¼š`ffmpeg -f *gdigrab* -i "1:0" -vcodec libx264 -preset ultrafast -acodec libmp3lame -ar 44100 -ac 1 -f flv rtmp://127.0.0.1:1935/rtmplive/home`
- **å±å¹•&éº¦å…‹é£&æ‘„åƒå¤´**ï¼š`ffmpeg -f avfoundation -framerate 30 -i "1:0" \-f avfoundation -framerate 30 -video_size 640x480 -i "0" \-c:v libx264 -preset ultrafast \-filter_complex 'overlay=main_w-overlay_w-10:main_h-overlay_h-10' -acodec libmp3lame -ar 44100 -ac 1 -f flv rtmp://localhost:1935/rtmplive/home`

æ³¨æ„ï¼Œä¸Šè¿°å‘½ä»¤ä»…ä½œä¸ºæµ‹è¯•æ—¶çš„å‚è€ƒï¼Œç”¨äºç¡®å®š`nginx rtmp`ç›¸å…³é…ç½®åŠ`ffmpeg`é…ç½®æˆæœæƒ…å†µï¼Œå®é™…åº”å½“å‚è€ƒç›¸å…³éœ€æ±‚è®¾ç½®`ffmpeg`å‚æ•°ã€‚

## æ¨æ‹‰æµæµ‹è¯•(Linuxç«¯)
> ä¸Šè¯¾çš„æ—¶å€™è¢«è€å¸ˆå»ºè®®ç”¨`linux`æ¥æ­å»ºç³»ç»ŸQAQâ€¦â€¦è™½ç„¶ä¹‹å‰å°è¯•è¿‡ï¼Œä½†æ˜¯åœ¨åšæ¨æµæµ‹è¯•çš„æ—¶å€™è¸©äº†å¤§å‘ï¼Œé‚åŠé€”å¼ƒå‘â€¦â€¦ä½†æ˜¯è§‰å¾—è¿˜æ˜¯é€ƒä¸æ‰ï¼Œä¸å¦‚å‹‡æ•¢é¢å¯¹å§ã€‚

ï¼ˆè·‘è·¯äº†ï¼Œå·¦è½¬`WebRTC.md`â†’_â†’ï¼‰


# å‚è€ƒå†…å®¹

1. `ffmpeg`åŸºç¡€ï¼š[A quick guide to using FFmpeg to convert media files | Opensource.com](https://opensource.com/article/17/6/ffmpeg-convert-media-file-formats)
2. `windows`ç³»ç»Ÿä¸‹è½½`ffmpeg`åŠç¯å¢ƒé…ç½®ï¼š[Windowsä¸‹è½½FFmpegæœ€æ–°ç‰ˆï¼ˆè¸©äº†ä¸€ä¸Šåˆçš„å‘ç»ˆäºæˆåŠŸï¼‰ - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/390924591)
3. `windows`ç«¯æ­å»º`nginx rtmp`æœåŠ¡å™¨ï¼š[Windows æ­å»º nginx RTMP æœåŠ¡å™¨ - fengMisaka - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/linuxAndMcu/p/12517787.html#:~:text=%E6%8C%89%E4%BD%8F%20windows%20%E9%94%AE%20%2BR%EF%BC%8C%E8%BE%93%E5%85%A5%20cmd%EF%BC%8C%E8%BF%9B%E5%85%A5%20cmd%20%E5%91%BD%E4%BB%A4%E7%AA%97%E5%8F%A3%EF%BC%8C%E8%BF%9B%E5%85%A5,nginx%20%E7%9B%AE%E5%BD%95%EF%BC%9A%20cd%20E%3Atechnology%5B%26ng%26%5Dinx-1.17.9%20%EF%BC%8C%E7%84%B6%E5%90%8E%E5%90%AF%E5%8A%A8%20nginx%20rtmp%20%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%9A)
4. `python`ä¸­`ffmpeg-video-streaming`åŒ…ï¼š[python-ffmpeg-video-streaming Â· PyPI](https://pypi.org/project/python-ffmpeg-video-streaming/)ï¼Œç›¸å…³æ–‡æ¡£å‚è€ƒï¼š[Python FFmpeg Video Streaming - Quick Start (aminyazdanpanah.com)](https://video.aminyazdanpanah.com/python/start?r=dash)
5. `ffmpeg`æ¨æ‹‰æµæµ‹è¯•ï¼š[Windows æ­å»º nginx rtmpæœåŠ¡å™¨ - microsoftzhcn - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/sntetwt/p/11435564.html)
6. å‰ç«¯`flv.js`æ‹‰æµä»‹ç»ï¼š[è§†é¢‘ç›´æ’­çŸ¥è¯†ä¹‹å››ï¼šç›´æ’­DEMOâ€”â€”RTMPæ¨æµå’ŒHTTP-FLVæ‹‰æµ | murphylee blog (seminelee.com)](https://seminelee.com/2021/06/20/video-4/)
7. `linux`ç«¯çš„`nginx`éƒ¨ç½²ï¼š[é€šè¿‡ nginx æ­å»ºä¸€ä¸ªåŸºäº http-flv çš„ç›´æ’­æµåª’ä½“æœåŠ¡å™¨ â€“ 92ITğŸ€](http://123.57.164.21/?p=1458)
8. `ffmpeg`å¸¸ç”¨æ¨æµæŒ‡ä»¤ï¼š[FFmpegå¸¸ç”¨æ¨æµå‘½ä»¤ - ç®€ä¹¦ (jianshu.com)](https://www.jianshu.com/p/d541b317f71c)
