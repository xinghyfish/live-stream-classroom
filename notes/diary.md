# 浮生日记

这个文档主要记录开发时遇到的一些问题和解决方案、一些自己的idea，恰如建筑完成后保留的脚手架的草图，也算是记年轻时候生活的`clog`吧（笑）。

> 高斯的粉丝不要激动，这里并没有任何言外之意，请保持冷静。

## 小记

2022年的上半年，没有如愿返校，而是像两年前一样留在家乡。回想起来，高中毕业后整整36个月，满打满算只有16个月真正留在学校，还是比较唏嘘，怎么也算人生的遗憾，但是比起疫情和战争肆虐的地区生活的民众，又觉得自己非常幸运。
前段时间，整个人都被一种抑郁的情绪包裹，先前积压的情绪一下子聚集成一团乌云将自己围绕起来，总觉得有一种窒息感，对未来的悲观和无力将整个人的精神压倒了。
我自己当然知道这种情绪是非常消极的，也在寻找一些改变的契机。有两个人在这段时间给了我很大的思考。

第一位是SpaceX的创始人Elon Musk。记者问道，SpaceX早期多次火箭试射失败，公司命悬一线时，他有想过放弃吗，他回答道：

> 要么死的安然，要么活的绚烂。

第二位是MIT的计算机博士周信静。他在一所职业类高中考上大专，并完成了专升本，在杭电修读学士学位，在浙江大学修读硕士学位，在20年收到了MIT的博士offer。
这他妈才是programmer！

小叙片刻，聊以慰藉，以下正文。（2022年5月13日晚）

# 概述
本项目为在线教学直播平台，主要需要实现以下功能：
- [x] Web端在线聊天（必做）
- [ ] Web端在线音频信息传输（必做）
- [x] Web端白板（必做）
- [ ] Web端签到功能（必做）
下面主要针对以上四个主要功能设计的核心技术进行简要的设计和说明。具体的细节参考相关代码即可。这里主要针对实现时对web程序开发的技术考量和实现时遇到的问题进行简单的记录。深层次的问题可以在项目的issues中进行讨论。

## WebSocket
在课程第一阶段的聊天室的演示中，由于工期较短（实际上是前期摸鱼），当时采取的策略是将用户发送的消息存储到数据库，通过数据库实现聊天记录的存储和历史消息的呈现。但是这样的实现方案出现了一些问题：服务器无法将A用户发送的消息即时推送给用户B，因此用户B无法即时接受用户A的消息。
当时选择了一个非常草率的方案解决这个问题——通过前端内嵌一个自动刷新函数，50ms自动刷新一次，将用户的聊天记录通过后端来传递给前端，而不是通过服务器。这虽然在表面上解决了即时呈现用户消息的功能，但是在【聊天记录】这一功能无法实现。初步分析结果为过于频繁的刷新导致`Javascript`脚本执行被中断。
因此，在最终的项目实现中，决定痛改前非，将之前看到的`websocket`应用到直播间聊天室这一场景中。

### 介绍

- 教程：https://www.ruanyifeng.com/blog/2017/05/websocket.html

#### 1. 前世今生
在互联网中，最广泛使用的协议是`http`协议。`http`协议由客户端发起，用于向服务器请求资源。但是该协议的缺陷在于其**单向性**，即服务器无法主动向客户端推送信息。
如果服务器的状态连续发生改变，客户端很难获取，必须采取**轮询**策略，了解服务器状态是否发生变化。轮询策略本质上是不断进行请求，因此会不断进行HTTP连接，或者一直保持连接，效率很低。因此，`websocket`应运而生。

#### 2. 简介
Websocket协议的原理如下图所示。客户端首先向服务器发出请求(挥手)，服务器作出响应后，建立连接(双向平等对话)。之后，客户端和服务器均可以向对方主动推送消息。
![HTTP vs Websocket](https://www.ruanyifeng.com/blogimg/asset/2017/bg2017051502.png)
Websocket具有如下特点：
1. 建立在TCP协议上
2. 和HTTP协议兼容性好，默认端口也是`80`和`443`，且握手阶段采用http协议，能通过各种http代理服务器
3. 协议的**标识符**为`ws`（加密为`wss`），服务器地址为URL

基于上述特点，根据教程内容可以了解客户端API。由于这是一个web端的应用，客户端API主要是用`js`实现。服务器端的实现则多种多样，这里选用的是后端框架`tornado`，通过路由表将协议交给对应的`Handler`处理（继承父类），
本项目中聊天室客户端代码参考`/client/view/live.html`，服务器端代码参考`main.py`（路由表）和`/client/controller/websocket.py`。
